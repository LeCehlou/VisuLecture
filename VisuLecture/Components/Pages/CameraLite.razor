@page "/camera-lite"
@rendermode InteractiveServer
@inject IJSRuntime JS
@inject AppState AppState

<h3>Lier la caméra (navigateur par défaut)</h3>

<div class="space-x-2">
    <button class="btn btn-primary" @onclick="StartAsync">Démarrer</button>
</div>

<video id="preview" autoplay playsinline muted
       style="width:100%;max-width:640px;background:#000;border-radius:12px;"></video>

@if (!string.IsNullOrEmpty(Info))
{
    <div class="alert alert-info">@Info</div>
}

@code {
    private IJSObjectReference? _mod;
    private string FacingMode = "user"; // "environment" pour caméra arrière (mobile)
    private string? Info;

    private record DeviceInfo(string? deviceId, string? label);

    private async Task StartAsync()
    {
        _mod ??= await JS.InvokeAsync<IJSObjectReference>("import", "/js/cam-min.js"); 
        var di = await _mod.InvokeAsync<DeviceInfo>("ensureStream", "preview", FacingMode);
        AppState.Camera = new Camera(di.deviceId, AppState.JsRuntime);
        Info = $"Caméra liée: {di.label} (deviceId: {di.deviceId ?? "inconnu"})";
    }
}